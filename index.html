<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Path of Hideout — Flips</title>
    <meta name="description" content="Essence Flip and Fossil Flip — quick tools" />
    <style>
      :root{
        --bg1: linear-gradient(135deg,#0f172a 0%,#0b1220 50%,#071127 100%);
        --card:#0b1226;
        --muted:#9aa4b2;
        --accent:#6ee7b7;
        --glass: rgba(255,255,255,0.03);
        --radius:14px;
        color-scheme: dark;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }
      html,body{height:100%;margin:0}
      body{
        display:flex;align-items:center;justify-content:center;
        background:var(--bg1);background-size:200% 200%;
        padding:32px;color:#e6eef6;line-height:1.4;
      }
      .container{
        width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
        border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,0.6);
        overflow:hidden;border:1px solid rgba(255,255,255,0.03);
      }
      header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px}
      .brand{display:flex;gap:12px;align-items:center}
      .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),#60a5fa);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#052225}
      h1{font-size:18px;margin:0}
      p.lead{margin:0;color:var(--muted);font-size:13px}

      /* Tabs */
      .tabs{display:flex;gap:8px;padding:12px 20px;background:var(--glass);border-top:1px solid rgba(255,255,255,0.02);}
      .tab{background:transparent;border:0;padding:10px 14px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:600}
      .tab[aria-selected="true"]{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));color:var(--accent);box-shadow:inset 0 -2px 0 rgba(0,0,0,0.4)}
      .tab:focus{outline:2px solid rgba(110,231,183,0.18);outline-offset:2px}

      .panel-wrap{display:flex;padding:28px;gap:24px;flex-wrap:wrap}
      .panel{flex:1 1 320px;min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
      .panel h2{margin:0 0 8px 0;font-size:16px}
      .muted{color:var(--muted);font-size:13px}
      .cta{margin-top:12px;display:inline-flex;gap:8px}
      .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer}

      footer{padding:14px 20px;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02);}

      @media (max-width:640px){body{padding:16px}.panel-wrap{padding:18px;gap:12px}}
    </style>
  </head>
  <body>
    <div class="container" role="application">
      <header>
        <div class="brand">
          <div class="logo">PH</div>
          <div>
            <h1>Path of Hideout</h1>
            <p class="lead">Quick helpers for Essence and Fossil flipping</p>
          </div>
        </div>
      </header>

      <nav class="tabs" role="tablist" aria-label="Flip tools">
        <button class="tab" role="tab" id="tab-essence" aria-controls="panel-essence" aria-selected="true">Essence Flip</button>
        <button class="tab" role="tab" id="tab-fossil" aria-controls="panel-fossil" aria-selected="false">Fossil Flip</button>
      </nav>

      <main>
        <div class="panel-wrap">
          <section class="panel" id="panel-essence" role="tabpanel" aria-labelledby="tab-essence">
            <h2>Essence Flip</h2>
            <p class="muted">Tool to compute an optimal stop-threshold for flipping essence tiers using Harvest (uniform swap) with a swap cost.</p>

            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
              <label style="flex:1 1 160px">Start count<br><input id="startCount" type="number" min="1" value="10" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></label>
              <label style="flex:1 1 220px">Start type<br><select id="startType" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);color:inherit"></select></label>
              <label style="flex:1 1 160px">Craft cost (chaos)<br><input id="swapCost" type="number" min="0" step="0.1" value="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></label>
            </div>

            <details style="margin-top:12px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)">
              <summary style="cursor:pointer">Essence prices (Defeaning tier) — edit values</summary>
              <div id="pricesTable" style="margin-top:10px;display:grid;grid-template-columns:1fr 120px;gap:8px"></div>
            </details>

            <div class="cta" style="margin-top:12px">
              <button class="btn" id="computeBtn">Compute Strategy</button>
            </div>

            <div id="results" style="margin-top:14px"></div>
          </section>

          <section class="panel" id="panel-fossil" role="tabpanel" aria-labelledby="tab-fossil" hidden>
            <h2>Fossil Flip</h2>
            <p class="muted">Placeholder for Fossil Flip tools. Essence flipping logic has been moved to the Essence Flip tab.</p>
            <div class="cta">
              <button class="btn" onclick="alert('Fossil Flip placeholder')">Run Demo</button>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      (function(){
        const tabs = Array.from(document.querySelectorAll('.tab'));
        const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));
        function show(index, focus=true){
          tabs.forEach((t,i)=>{
            const sel = i===index;
            t.setAttribute('aria-selected', sel);
            panels[i].hidden = !sel;
          });
          if(focus) tabs[index].focus();
          try{localStorage.setItem('pohtab', index)}catch(e){}
        }
        tabs.forEach((t,i)=>{
          t.addEventListener('click', ()=> show(i,false));
          t.addEventListener('keydown', (e)=>{
            if(e.key === 'ArrowRight') show((i+1)%tabs.length);
            if(e.key === 'ArrowLeft') show((i-1+tabs.length)%tabs.length);
          });
        });
        // restore
        let start = 0;
        try{ const saved = localStorage.getItem('pohtab'); if(saved!=null) start = Number(saved); }catch(e){}
        show(start,false);

        // --- Fossil/Essence flip logic ---
        // Default essence prices (Defeaning tier) in Standard League
        const defaultPrices = {
          'Scorn': 56,
          'Rage': 42,
          'Spite': 42,
          'Woe': 37,
          'Zeal': 30,
          'Envy': 24,
          'Sorrow': 23,
          'Loathing': 21,
          'Wrath': 21,
          'Contempt': 20,
          'Misery': 17,
          'Torment': 17,
          'Greed': 15,
          'Anger': 14,
          'Hatred': 14,
          'Suffering': 5.0,
          'Doubt': 4.0,
          'Dread': 3.0,
          'Fear': 1.0,
        };

        function initPrices(){
          const pricesTable = document.getElementById('pricesTable');
          const startType = document.getElementById('startType');
          pricesTable.innerHTML = '';
          startType.innerHTML = '';
          for(const k of Object.keys(defaultPrices)){
            const wrapper = document.createElement('div');
            wrapper.style.display = 'contents';
            const label = document.createElement('label');
            label.textContent = k;
            label.style.alignSelf = 'center';
            const input = document.createElement('input');
            input.type = 'number'; input.step = '0.1'; input.value = defaultPrices[k];
            input.style.padding = '8px'; input.style.borderRadius = '8px'; input.style.border = '1px solid rgba(255,255,255,0.04)'; input.style.background = 'transparent'; input.style.color = 'inherit';
            input.dataset.key = k;
            pricesTable.appendChild(label);
            pricesTable.appendChild(input);

            const opt = document.createElement('option'); opt.value = k; opt.textContent = k; startType.appendChild(opt);
          }
        }

        function readPrices(){
          const inputs = Array.from(document.querySelectorAll('#pricesTable input'));
          const prices = {};
          inputs.forEach(i=> prices[i.dataset.key] = Number(i.value));
          return prices;
        }

        // Compute threshold C via fixed-point: C = f(C) - cost where f(C) = avg(max(price_i, C))
        function computeThreshold(pricesArr, cost){
          const N = pricesArr.length;
          const minP = Math.min(...pricesArr);
          const maxP = Math.max(...pricesArr);
          let low = minP - cost - 10; // safe lower bound
          let high = maxP + 10;
          for(let iter=0; iter<80; iter++){
            const mid = (low+high)/2;
            const f = pricesArr.reduce((s,p)=> s + Math.max(p, mid), 0) / N;
            const lhs = f - cost; // avg_V - cost
            if(lhs > mid) low = mid; else high = mid;
          }
          const C = (low+high)/2;
          return C;
        }

        function computeStrategy(){
          const pricesObj = readPrices();
          const types = Object.keys(pricesObj);
          const pricesArr = types.map(t=> pricesObj[t]);
          const cost = Number(document.getElementById('swapCost').value) || 0;
          const C = computeThreshold(pricesArr, cost);
          const V = {};
          types.forEach((t,i)=> V[t] = Math.max(pricesArr[i], C));
          const start = document.getElementById('startType').value;
          const count = Math.max(1, Math.floor(Number(document.getElementById('startCount').value) || 1));
          const expectedPer = V[start];
          const totalExpected = expectedPer * count;
          const immediate = pricesObj[start] * count;
          const profit = totalExpected - immediate;

          // Which types to stop at
          const stopTypes = types.filter(t=> pricesObj[t] >= C);

          const res = document.getElementById('results');
          res.innerHTML = '';
          const summary = document.createElement('div');
          summary.innerHTML = `<strong>Threshold (C):</strong> ${C.toFixed(3)} chaos — <strong>Stop types:</strong> ${stopTypes.join(', ')}`;
          res.appendChild(summary);

          const table = document.createElement('table');
          table.style.width = '100%'; table.style.marginTop = '10px'; table.style.borderCollapse = 'collapse';
          const hdr = document.createElement('tr'); hdr.innerHTML = '<th style="text-align:left">Type</th><th style="text-align:right">Price</th><th style="text-align:right">V (optimal)</th><th style="text-align:left">Action</th>';
          table.appendChild(hdr);
          types.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t}</td><td style="text-align:right">${pricesObj[t].toFixed(2)}</td><td style="text-align:right">${V[t].toFixed(3)}</td><td>${pricesObj[t] >= C ? 'Keep / Stop' : 'Flip'}</td>`;
            table.appendChild(tr);
          });
          res.appendChild(table);

          const footer = document.createElement('div'); footer.style.marginTop='10px';
          footer.innerHTML = `<div><strong>Start:</strong> ${count} × ${start} (price ${pricesObj[start].toFixed(2)})</div>
                              <div><strong>Expected final per essence:</strong> ${expectedPer.toFixed(3)} chaos</div>
                              <div><strong>Expected total value:</strong> ${totalExpected.toFixed(3)} chaos</div>
                              <div style="color:${profit>=0? 'var(--accent)': '#f87171'}"><strong>Expected profit vs immediate sell:</strong> ${profit.toFixed(3)} chaos</div>`;
          res.appendChild(footer);
        }

        document.getElementById('computeBtn').addEventListener('click', computeStrategy);
        initPrices();
      })();
    </script>
  </body>
</html>
