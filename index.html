<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Path of Hideout — Flips</title>
    <meta name="description" content="Essence Flip and Fossil Flip — quick tools" />
    <style>
      :root{
        --bg1: linear-gradient(135deg,#0f172a 0%,#0b1220 50%,#071127 100%);
        --card:#0b1226;
        --muted:#9aa4b2;
        --accent:#6ee7b7;
        --glass: rgba(255,255,255,0.03);
        --radius:14px;
        color-scheme: dark;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }
      html,body{height:100%;margin:0}
      body{
        display:flex;align-items:flex-start;justify-content:center;
        background:var(--bg1);background-size:200% 200%;
        padding:48px;color:#e6eef6;line-height:1.4;
      }
      .container{
        width:100%;max-width:1400px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
        border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,0.6);
        overflow:hidden;border:1px solid rgba(255,255,255,0.03);
      }
      header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px}
      .brand{display:flex;gap:12px;align-items:center}
      .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),#60a5fa);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#052225}
      h1{font-size:18px;margin:0}
      p.lead{margin:0;color:var(--muted);font-size:13px}

      /* Tabs */
      .tabs{display:flex;gap:8px;padding:12px 20px;background:var(--glass);border-top:1px solid rgba(255,255,255,0.02);}
      .tab{background:transparent;border:0;padding:10px 14px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:600}
      .tab[aria-selected="true"]{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));color:var(--accent);box-shadow:inset 0 -2px 0 rgba(0,0,0,0.4)}
      .tab:focus{outline:2px solid rgba(110,231,183,0.18);outline-offset:2px}

      .panel-wrap{display:flex;padding:28px;gap:24px;flex-wrap:wrap}
      .panel{flex:1 1 320px;min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
      .panel h2{margin:0 0 8px 0;font-size:16px}
      .muted{color:var(--muted);font-size:13px}
      .hint{margin-left:8px;color:var(--muted);cursor:help;font-size:12px;vertical-align:middle}
      .cta{margin-top:12px;display:inline-flex;gap:8px}
      .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer}

      footer{padding:14px 20px;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02);}

      @media (max-width:640px){body{padding:16px}.panel-wrap{padding:18px;gap:12px}}
      /* Results table styling */
      #results{overflow-x:auto}
      .results-table{width:100%;border-collapse:collapse;table-layout:fixed}
      .results-table col{width:25%}
      .results-table th, .results-table td{padding:6px 10px;vertical-align:middle}
      .results-table th{font-weight:600}
      .results-table td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    </style>
  </head>
  <body>
    <div class="container" role="application">
      <header>
        <div class="brand">
          <div class="logo">PH</div>
          <div>
            <h1>Path of Hideout</h1>
            <p class="lead">Quick helpers for Essence and Fossil flipping</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label for="leagueSelect" style="color:var(--muted);font-size:13px;margin:0">League</label>
          <select id="leagueSelect" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);color:inherit">
            <option value="Keepers">Temporary League</option>
            <option value="Standard" selected>Standard League</option>
          </select>
        </div>
      </header>

      <nav class="tabs" role="tablist" aria-label="Flip tools">
        <button class="tab" role="tab" id="tab-essence" aria-controls="panel-essence" aria-selected="true">Essence Flip</button>
      </nav>

      <main>
        <div class="panel-wrap">
          <section class="panel" id="panel-essence" role="tabpanel" aria-labelledby="tab-essence">
            <h2>Essence Flip</h2>
            <p class="muted">Tool to compute an optimal stop-threshold for flipping essence tiers using Harvest (uniform swap) with a swap cost. If you are interested, this is the <a href="https://github.com/bholms/PathOfHideout/blob/main/docs/essence-flip-math.md" target="_blank" style="color:var(--accent);text-decoration:underline">proof</a>.</p>

            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
              <label style="flex:1 1 160px">Start count<br><input id="startCount" type="number" min="1" value="10" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></label>
              <label style="flex:1 1 220px">Start type<br><select id="startType" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);color:inherit"></select></label>
              <label style="flex:1 1 160px">Blue lifeforce per div <span class="hint" title="Number of blue lifeforce per 1 Divine Orb">ⓘ</span><br><input id="bluePerDiv" type="number" min="0.0001" step="0.001" value="6000" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></label>
              <label style="flex:1 1 160px">Chaos per div <span class="hint" title="Chaos value gained by selling one div"><span class="hint">ⓘ</span></span><br><input id="chaosPerDiv" type="number" min="0" step="0.1" value="400" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></label>
            </div>

            <details style="margin-top:12px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)">
              <summary style="cursor:pointer">Essence prices (Defeaning tier) — edit values</summary>
              <div id="pricesTable" style="margin-top:10px;display:grid;grid-template-columns:1fr 120px;gap:8px"></div>
            </details>

            <div class="cta" style="margin-top:12px">
              <button class="btn" id="computeBtn">Compute Strategy</button>
              <button class="btn" id="refreshPricesBtn" style="border-color: rgba(255,255,255,0.06);">Refresh prices</button>
            </div>

            <div id="results" style="margin-top:14px"></div>
          </section>

        </div>
      </main>
    </div>

    <script>
      (function(){
        const tabs = Array.from(document.querySelectorAll('.tab'));
        const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));
        function show(index, focus=true){
          tabs.forEach((t,i)=>{
            const sel = i===index;
            t.setAttribute('aria-selected', sel);
            panels[i].hidden = !sel;
          });
          if(focus) tabs[index].focus();
          try{localStorage.setItem('pohtab', index)}catch(e){}
        }
        tabs.forEach((t,i)=>{
          t.addEventListener('click', ()=> show(i,false));
          t.addEventListener('keydown', (e)=>{
            if(e.key === 'ArrowRight') show((i+1)%tabs.length);
            if(e.key === 'ArrowLeft') show((i-1+tabs.length)%tabs.length);
          });
        });
        // restore
        let start = 0;
        try{ const saved = localStorage.getItem('pohtab'); if(saved!=null) start = Number(saved); }catch(e){}
        show(start,false);

        // --- Fossil/Essence flip logic ---
        // Default essence prices (Defeaning tier) in Standard League
        const defaultPrices = {
          'Scorn': 56,
          'Rage': 42,
          'Spite': 42,
          'Woe': 37,
          'Zeal': 30,
          'Envy': 24,
          'Sorrow': 23,
          'Loathing': 21,
          'Wrath': 21,
          'Contempt': 20,
          'Misery': 17,
          'Torment': 17,
          'Greed': 15,
          'Anger': 14,
          'Hatred': 14,
          'Suffering': 5.0,
          'Doubt': 4.0,
          'Dread': 3.0,
          'Fear': 1.0,
        };

        function initPrices(){
          const pricesTable = document.getElementById('pricesTable');
          const startType = document.getElementById('startType');
          pricesTable.innerHTML = '';
          startType.innerHTML = '';
          const keys = Object.keys(defaultPrices);
          for(const k of keys){
            const wrapper = document.createElement('div');
            wrapper.style.display = 'contents';
            const label = document.createElement('label');
            label.textContent = k;
            label.style.alignSelf = 'center';
            const input = document.createElement('input');
            input.type = 'number'; input.step = '0.1'; input.value = defaultPrices[k];
            input.style.padding = '8px'; input.style.borderRadius = '8px'; input.style.border = '1px solid rgba(255,255,255,0.04)'; input.style.background = 'transparent'; input.style.color = 'inherit';
            input.dataset.key = k;
            pricesTable.appendChild(label);
            pricesTable.appendChild(input);

            const opt = document.createElement('option'); opt.value = k; opt.textContent = k; startType.appendChild(opt);
          }
          // default to the last option in the list
          if(keys.length > 0) startType.value = keys[keys.length - 1];
        }

        function readPrices(){
          const inputs = Array.from(document.querySelectorAll('#pricesTable input'));
          const prices = {};
          inputs.forEach(i=> prices[i.dataset.key] = Number(i.value));
          return prices;
        }

        // Compute threshold C via fixed-point: C = f(C) - cost where f(C) = avg(max(price_i, C))
        function computeThreshold(pricesArr, cost){
          const N = pricesArr.length;
          const minP = Math.min(...pricesArr);
          const maxP = Math.max(...pricesArr);
          let low = minP - cost - 10; // safe lower bound
          let high = maxP + 10;
          for(let iter=0; iter<80; iter++){
            const mid = (low+high)/2;
            const f = pricesArr.reduce((s,p)=> s + Math.max(p, mid), 0) / N;
            const lhs = f - cost; // avg_V - cost
            if(lhs > mid) low = mid; else high = mid;
          }
          const C = (low+high)/2;
          return C;
        }

        function computeStrategy(){
          const pricesObj = readPrices();
          const types = Object.keys(pricesObj);
          const pricesArr = types.map(t=> pricesObj[t]);
          // compute craft cost per flip
          // prefer using fetched chaos per lifeforce (if available): cost = 30 * chaosPerLifeforce
          const bluePerDiv = Number(document.getElementById('bluePerDiv').value) || 0; // blue lifeforce per 1 divine
          const chaosPerDiv = Number(document.getElementById('chaosPerDiv').value) || 0; // chaos per divine
          let cost = 0;
          // Prefer user-entered textbox values when available
          if(chaosPerDiv > 0 && bluePerDiv > 0){
            const chaosPerBlueDerived = chaosPerDiv / bluePerDiv;
            cost = 30 * chaosPerBlueDerived;
          } else if(fetchedChaosPerLifeforce != null && typeof fetchedChaosPerLifeforce === 'number'){
            // fall back to fetched chaos per blue lifeforce
            cost = 30 * fetchedChaosPerLifeforce;
          } else {
            cost = 0;
          }
          const C = computeThreshold(pricesArr, cost);
          const V = {};
          types.forEach((t,i)=> V[t] = Math.max(pricesArr[i], C));
          const start = document.getElementById('startType').value;
          const count = Math.max(1, Math.floor(Number(document.getElementById('startCount').value) || 1));
          const expectedPer = V[start];
          const totalExpected = expectedPer * count;
          const immediate = pricesObj[start] * count;
          const profit = totalExpected - immediate;

          // Which types to stop at
          const stopTypes = types.filter(t=> pricesObj[t] >= C);

          // Expected flips / craft cost (cost is per-flip per-essence)
          const q = stopTypes.length / types.length; // probability a random swap yields a stop-type
          let expectedFlipsPerEssence = 0;
          if(pricesObj[start] >= C) expectedFlipsPerEssence = 0; else expectedFlipsPerEssence = q > 0 ? (1 / q) : 0;
          const totalExpectedCraftCost = count * expectedFlipsPerEssence * cost;

          const res = document.getElementById('results');
          res.innerHTML = '';
          const summary = document.createElement('div');
          function fmtChaosDiv(v){
            if(chaosPerDiv > 0) return `${v.toFixed(3)} chaos / ${(v/chaosPerDiv).toFixed(3)} div`;
            return `${v.toFixed(3)} chaos / — div`;
          }
          summary.innerHTML = `<strong>Threshold (C):</strong> ${fmtChaosDiv(C)} — <strong>Stop types:</strong> ${stopTypes.join(', ')}`;
          res.appendChild(summary);

          const table = document.createElement('table');
          table.className = 'results-table';
          table.style.marginTop = '10px';
          // ensure columns are evenly spaced via CSS colgroup
          const cg = document.createElement('colgroup');
          for(let i=0;i<4;i++){ const c = document.createElement('col'); cg.appendChild(c); }
          table.appendChild(cg);
          const hdr = document.createElement('tr'); hdr.innerHTML = '<th style="text-align:left">Type</th><th style="text-align:left">Price (c)</th><th style="text-align:left">Optimal Value (c)</th><th style="text-align:left">Optimal Action</th>';
          table.appendChild(hdr);
          // display types sorted by price (high -> low)
          const sortedTypes = types.slice().sort((a,b) => (pricesObj[b] || 0) - (pricesObj[a] || 0));
          sortedTypes.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t}</td><td style="text-align:left;overflow:hidden">${pricesObj[t].toFixed(2)}</td><td style="text-align:left;overflow:hidden">${V[t].toFixed(3)}</td><td style="padding-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${pricesObj[t] >= C ? 'Keep / Stop' : 'Flip'}</td>`;
            table.appendChild(tr);
          });
          res.appendChild(table);

          const footer = document.createElement('div'); footer.style.marginTop='10px';
          footer.innerHTML = `<div><strong>Start:</strong> ${count} × ${start} (price ${fmtChaosDiv(pricesObj[start])})</div>
                              <div><strong>Craft per flip (computed):</strong> ${fmtChaosDiv(cost)}</div>
                              <div><strong>Expected final per essence:</strong> ${fmtChaosDiv(expectedPer)}</div>
                              <div><strong>Expected flips per essence:</strong> ${expectedFlipsPerEssence.toFixed(3)}</div>
                              <div><strong>Expected craft cost:</strong> ${fmtChaosDiv(totalExpectedCraftCost)}</div>
                              <div><strong>Expected total value:</strong> ${fmtChaosDiv(totalExpected)}</div>
                              <div style="color:${profit>=0? 'var(--accent)': '#f87171'}"><strong>Expected profit vs immediate sell:</strong> ${fmtChaosDiv(profit)}</div>`;
          res.appendChild(footer);
        }

        document.getElementById('computeBtn').addEventListener('click', computeStrategy);
        // initialize UI from embedded defaults
        initPrices();

        // Try to fetch live essence prices from poe.ninja on first load
        // and then periodically every 10 minutes while page is open.

        // debug helper: prints arbitrary payload (prices, currencyRates, etc.)
        function updateDebug(payload, source='fallback'){
          try{
            const out = { timestamp: new Date().toISOString(), source, data: payload };
            const el = document.getElementById('fetchDebug');
            if(el) el.textContent = JSON.stringify(out, null, 2);
          }catch(e){/* ignore */}
        }

        // fetched currency rates (chaos per lifeforce, chaos per div)
        let fetchedChaosPerLifeforce = null;
        let fetchedChaosPerDiv = null;

        async function fetchPoeNinjaPrices(){
          // use the Cloudflare Worker proxy to avoid CORS issues
          const url = 'https://jolly-dew-18cc.jw11011.workers.dev/';
          // clone defaults as fallback
          const prices = Object.assign({}, defaultPrices);

          function updateUI(pr){
            // update inputs in the prices table if present
            const inputs = Array.from(document.querySelectorAll('#pricesTable input'));
            inputs.forEach(i=>{
              const k = i.dataset.key;
              if(k && pr[k] != null) i.value = pr[k];
            });
            // also update debug output
            try{ updateDebug(pr, 'proxy'); }catch(e){}
            try{ log('Prices updated in UI'); }catch(e){}
          }

          try{
            try{ log('Requesting prices from proxy...'); }catch(e){}
            // include selected league as query parameter so the proxy/worker can forward appropriately
            const leagueSel = (document.getElementById('leagueSelect') && document.getElementById('leagueSelect').value) ? document.getElementById('leagueSelect').value : 'Standard';
            const fetchUrl = url + '?league=' + encodeURIComponent(leagueSel);
            const res = await fetch(fetchUrl, {mode: 'cors'});
            if(!res.ok) throw new Error('Fetch failed');
            const data = await res.json();

            if(data && Array.isArray(data.lines)){
              const prefix = 'Deafening Essence of ';
              data.lines.forEach(item => {
                const name = item.name || item.baseType || '';
                if(typeof name === 'string' && name.startsWith(prefix)){
                  const key = name.substring(prefix.length).trim();
                  const chaos = item.chaosValue;
                  if(key && prices[key] != null && typeof chaos === 'number') prices[key] = chaos;
                }
              });
            }

            // also fetch currency rates (lifeforce/div) from wandering-lake proxy
            try{
              const leagueSel = (document.getElementById('leagueSelect') && document.getElementById('leagueSelect').value) ? document.getElementById('leagueSelect').value : 'Standard';
              const curUrl = 'https://wandering-lake-d156.jw11011.workers.dev/?league=' + encodeURIComponent(leagueSel);
              try{ log('Requesting currency rates from proxy...'); }catch(e){}
              const cres = await fetch(curUrl, {mode: 'cors'});
              if(cres && cres.ok){
                const cdata = await cres.json();
                const arr = Array.isArray(cdata) ? cdata : (Array.isArray(cdata.lines) ? cdata.lines : null);
                if(arr){
                  // find lifeforce and divine entries
                  for(const it of arr){
                    const id = (it.detailsId || '').toLowerCase();
                    const name = (it.currencyTypeName || '').toLowerCase();
                    if(id.includes('primal-crystallised-lifeforce') || name.includes('Primal Crystallised Lifeforce')){
                      // chaosEquivalent holds chaos per lifeforce
                      if(typeof it.chaosEquivalent === 'number'){
                        fetchedChaosPerLifeforce = it.chaosEquivalent;
                        // if we already have chaos per div, populate blue lifeforce per div = chaosPerDiv / chaosPerLifeforce
                        try{
                          if(fetchedChaosPerDiv != null && fetchedChaosPerLifeforce > 0){
                            const bluePerDivVal = fetchedChaosPerDiv / fetchedChaosPerLifeforce;
                            document.getElementById('bluePerDiv').value = bluePerDivVal.toFixed(3);
                          }
                        }catch(e){}
                      }
                    }
                    if(id.includes('divine-orb') || name.includes('divine orb')){
                      if(typeof it.chaosEquivalent === 'number'){
                        fetchedChaosPerDiv = it.chaosEquivalent;
                        document.getElementById('chaosPerDiv').value = fetchedChaosPerDiv.toFixed(2);
                        // if we already have chaos per lifeforce, populate bluePerDiv
                        try{
                          if(fetchedChaosPerDiv != null && fetchedChaosPerLifeforce > 0){
                            const bluePerDivVal = fetchedChaosPerDiv / fetchedChaosPerLifeforce;
                            document.getElementById('bluePerDiv').value = bluePerDivVal.toFixed(3);
                          }
                        }catch(e){}
                      }
                    }
                  }
                }
              }
            }catch(e){
              try{ log('Currency rates fetch failed: ' + (e && e.message? e.message : e)); }catch(e){}
            }

            // update UI with found prices
            updateUI(prices);
            try{ log('Prices fetched successfully from proxy'); }catch(e){}
            return prices;
          }catch(err){
            // on any error, leave defaults in place and update UI
            updateUI(prices);
            try{ updateDebug(prices, 'fallback'); }catch(e){}
            try{ log('Fetch failed, using fallback defaults: ' + (err && err.message ? err.message : err)); }catch(e){}
            return prices;
          }
        }

        // initial fetch and periodic refresh every 10 minutes
        try{ fetchPoeNinjaPrices(); }catch(e){}
        setInterval(()=>{ try{ fetchPoeNinjaPrices(); }catch(e){} }, 10 * 60 * 1000);
        // logging helper and manual refresh handler
        function log(msg){
          try{ console.log('fetch:', msg); }catch(e){}
        }

        // wire manual refresh button
        try{
          const rb = document.getElementById('refreshPricesBtn');
          if(rb) rb.addEventListener('click', ()=>{ log('Manual refresh triggered'); fetchPoeNinjaPrices(); });
        }catch(e){}
        // wire league selector to refresh prices when changed
        try{
          const ls = document.getElementById('leagueSelect');
          if(ls) ls.addEventListener('change', (ev)=>{ log('League changed to ' + ls.value); fetchPoeNinjaPrices(); });
        }catch(e){}
      })();
    </script>
  </body>
</html>
